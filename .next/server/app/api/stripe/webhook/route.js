"use strict";(()=>{var e={};e.id=757,e.ids=[757],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},74387:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>b,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>u});var i=r(49303),o=r(88716),a=r(60670),n=r(19692),c=r(69206),p=r(87070);async function u(e){let t;let r=await e.text(),s=e.headers.get("stripe-signature");try{t=c.A.webhooks.constructEvent(r,s,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook signature verification failed:",e),p.NextResponse.json({error:"Invalid signature"},{status:400})}let i=await (0,n.e)();try{switch(t.type){case"checkout.session.completed":{let e=t.data.object,r=e.metadata?.user_id,s=e.metadata?.type;if(r&&"credits"===s){let t=e.metadata?.package_id,s=parseInt(e.metadata?.credits||"0");if(s>0){let o=e.payment_intent,{error:a}=await i.rpc("add_credits",{user_id:r,amount:s,description:`Purchased ${s} credits`,package_id:t});a?console.error("Error adding credits:",a):(o&&await i.from("credit_transactions").update({stripe_payment_intent_id:o}).eq("user_id",r).eq("package_id",t).eq("type","purchased").order("created_at",{ascending:!1}).limit(1),console.log(`Successfully added ${s} credits for user ${r}`))}}break}case"customer.subscription.updated":{let e=t.data.object,r=e.customer,{data:s}=await i.from("users").select("id").eq("stripe_customer_id",r).single();s&&await i.from("users").update({subscription_status:e.status}).eq("id",s.id);break}case"customer.subscription.deleted":{let e=t.data.object.customer,{data:r}=await i.from("users").select("id").eq("stripe_customer_id",e).single();r&&await i.from("users").update({subscription_status:"canceled"}).eq("id",r.id);break}default:console.log(`Unhandled event type: ${t.type}`)}return p.NextResponse.json({received:!0})}catch(e){return console.error("Error processing webhook:",e),p.NextResponse.json({error:"Webhook processing failed"},{status:500})}}let d=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/macbook/Desktop/Projects/visionvalu_-ai-property-valuation/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:h}=d,x="/api/stripe/webhook/route";function b(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},69206:(e,t,r)=>{r.d(t,{A:()=>s});let s=new(r(61113)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-09-30.clover"})},19692:(e,t,r)=>{r.d(t,{e:()=>o});var s=r(2305),i=r(71615);async function o(){let e=await (0,i.cookies)();return(0,s.createServerClient)("https://bbbengshbvpqxtzrphov.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJiYmVuZ3NoYnZwcXh0enJwaG92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzcxNjYsImV4cCI6MjA3Njk1MzE2Nn0.CkmmMBMjbQlJgsgMjRLGfjE6fO-BXiis8nZflT16VX8",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:s})=>e.set(t,r,s))}catch{}}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,456,972,113],()=>r(74387));module.exports=s})();